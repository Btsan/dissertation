<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live AGMS Sketch Construction</title>
    <link rel="stylesheet" href="demo-common.css">
    <style>
        .main-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin: 40px 0;
        }

        .sketch-counter {
            width: 150px;
            height: 150px;
            border: 4px solid var(--color-dark);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .sketch-counter.pulse {
            transform: scale(1.1);
            border-color: var(--color-blue);
        }

        .sketch-val {
            font-size: 48px;
            font-weight: bold;
            color: var(--color-dark);
        }

        .sketch-label {
            font-size: 14px;
            color: var(--color-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .action-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }

        .btn-insert {
            background-color: var(--color-blue);
        }

        .btn-query {
            background-color: var(--color-green);
        }

        .btn-stream {
            background-color: var(--color-red);
        }

        .log-panel {
            margin-top: 30px;
            background: white;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
        }

        .log-entry.insert {
            color: var(--color-blue);
        }

        .log-entry.query {
            color: var(--color-green);
        }

        .hash-visual {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-gray);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .hash-visual.visible {
            opacity: 1;
        }

        .floating-item {
            position: fixed;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: floatDown 0.8s ease-out forwards;
            z-index: 100;
        }

        @keyframes floatDown {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(40px);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Live AGMS Sketch Construction</h2>

        <div class="main-display">
            <div class="sketch-counter" id="sketch-box">
                <div class="sketch-val" id="sketch-val">0</div>
                <div class="sketch-label">Sketch (s)</div>
            </div>
            <div class="hash-visual" id="hash-visual">
                ξ(x) = <span id="hash-val">?</span>
            </div>
        </div>

        <div class="action-panel">
            <div class="input-group">
                <input type="text" id="item-input" placeholder="Enter item (e.g., 'A', 'apple')..." maxlength="10">
                <button class="btn-insert" id="btn-insert">Insert</button>
                <button class="btn-query" id="btn-query">Query</button>
            </div>

            <div class="controls">
                <button class="btn-stream" id="btn-stream">Start Random Stream</button>
                <button style="background-color: var(--color-gray);" id="btn-reset">Reset</button>
            </div>
        </div>

        <div class="log-panel" id="log-panel">
            <div class="log-entry">System ready. Insert items to begin.</div>
        </div>
    </div>

    <script src="../kwisehash.js"></script>
    <script>
        const state = {
            sketch: 0,
            trueCounts: {},
            hash: new window.KWiseHash.SignHash(1, 4, 123), // 1 hash function
            isStreaming: false,
            streamInterval: null
        };

        const elements = {
            sketchVal: document.getElementById('sketch-val'),
            sketchBox: document.getElementById('sketch-box'),
            hashVisual: document.getElementById('hash-visual'),
            hashVal: document.getElementById('hash-val'),
            input: document.getElementById('item-input'),
            log: document.getElementById('log-panel'),
            btnInsert: document.getElementById('btn-insert'),
            btnQuery: document.getElementById('btn-query'),
            btnStream: document.getElementById('btn-stream'),
            btnReset: document.getElementById('btn-reset')
        };

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerHTML = msg;
            elements.log.insertBefore(div, elements.log.firstChild);
        }

        function getHash(item) {
            // Simple string hash for demo
            let code = 0;
            for (let i = 0; i < item.length; i++) code += item.charCodeAt(i);
            return state.hash.hash(code, 0);
        }

        function updateDisplay(hashVal) {
            elements.sketchVal.textContent = state.sketch;

            // Animate
            elements.sketchBox.classList.add('pulse');
            setTimeout(() => elements.sketchBox.classList.remove('pulse'), 200);

            if (hashVal !== undefined) {
                elements.hashVal.textContent = hashVal > 0 ? '+1' : '-1';
                elements.hashVal.style.color = hashVal > 0 ? 'var(--color-green)' : 'var(--color-red)';
                elements.hashVisual.classList.add('visible');
                setTimeout(() => elements.hashVisual.classList.remove('visible'), 1000);
            }
        }

        function spawnFloatingItem(item, hashVal) {
            const el = document.createElement('div');
            el.className = 'floating-item';
            el.textContent = `${item} (${hashVal > 0 ? '+1' : '-1'})`;
            el.style.color = hashVal > 0 ? 'var(--color-green)' : 'var(--color-red)';

            // Position relative to sketch box
            const rect = elements.sketchBox.getBoundingClientRect();
            // Use fixed positioning based on rect
            el.style.left = (rect.left + rect.width / 2 - 20) + 'px';
            el.style.top = (rect.top - 30) + 'px';

            document.body.appendChild(el);

            // Cleanup
            setTimeout(() => el.remove(), 800);
        }

        function insert(item) {
            if (!item) return;

            const h = getHash(item);
            state.sketch += h;
            state.trueCounts[item] = (state.trueCounts[item] || 0) + 1;

            spawnFloatingItem(item, h);
            updateDisplay(h);
            log(`<span>Inserted "<strong>${item}</strong>"</span> <span>s ← ${state.sketch - h} ${h > 0 ? '+' : '-'} 1 = ${state.sketch}</span>`, 'insert');
        }

        function query(item) {
            if (!item) return;

            const h = getHash(item);
            const estimate = state.sketch * h;
            const trueCount = state.trueCounts[item] || 0;

            updateDisplay(h);
            log(`<span>Query "<strong>${item}</strong>"</span> <span>Est: ${state.sketch} × (${h > 0 ? '+1' : '-1'}) = <strong>${estimate}</strong> (True: ${trueCount})</span>`, 'query');
        }

        // Event Listeners
        elements.btnInsert.onclick = () => {
            insert(elements.input.value.trim());
            elements.input.value = '';
            elements.input.focus();
        };

        elements.btnQuery.onclick = () => {
            query(elements.input.value.trim());
        };

        elements.btnReset.onclick = () => {
            state.sketch = 0;
            state.trueCounts = {};
            elements.log.innerHTML = '';
            updateDisplay();
            log('Sketch reset.');
        };

        elements.btnStream.onclick = () => {
            if (state.isStreaming) {
                clearInterval(state.streamInterval);
                state.isStreaming = false;
                elements.btnStream.textContent = "Start Random Stream";
                elements.btnStream.style.backgroundColor = "var(--color-red)";
            } else {
                state.isStreaming = true;
                elements.btnStream.textContent = "Stop Stream";
                elements.btnStream.style.backgroundColor = "var(--color-dark)";

                const items = ['A', 'B', 'C', 'D', 'E'];
                state.streamInterval = setInterval(() => {
                    const item = items[Math.floor(Math.random() * items.length)];
                    insert(item);
                }, 500);
            }
        };

        // Enter key support
        elements.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.btnInsert.click();
        });

    </script>
</body>

</html>