<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variance Visualization</title>
    <link rel="stylesheet" href="demo-common.css">
    <style>
        .chart-container {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 2px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-dark);
            padding-bottom: 5px;
        }

        .bar {
            flex: 1;
            background-color: var(--color-blue);
            transition: height 0.3s, background-color 0.2s;
            cursor: pointer;
            position: relative;
        }

        .bar:hover,
        .bar.selected {
            background-color: var(--color-red);
        }

        .formula-display {
            font-size: 1.2em;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .formula-term {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .highlight-f2 {
            background-color: #e0f2fe;
            color: var(--color-blue);
        }

        .highlight-fj {
            background-color: #fee2e2;
            color: var(--color-red);
        }

        .slider-container {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
        }

        .error-vis {
            position: relative;
            height: 60px;
            background: #f9fafb;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-range {
            height: 20px;
            background-color: rgba(239, 68, 68, 0.3);
            border-left: 2px solid var(--color-red);
            border-right: 2px solid var(--color-red);
            position: relative;
            transition: width 0.3s;
        }

        .error-center {
            width: 4px;
            height: 30px;
            background: var(--color-dark);
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .label {
            position: absolute;
            bottom: -25px;
            font-size: 12px;
            color: var(--color-gray);
            width: 100%;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Variance: Var[Z] = F₂ - fⱼ²</h2>

        <div class="slider-container">
            <label>Data Skew:</label>
            <input type="range" id="skew-slider" min="0" max="2" step="0.1" value="0">
            <span id="skew-val">Uniform</span>
        </div>

        <div class="chart-container" id="chart">
            <!-- Bars generated by JS -->
        </div>

        <div class="formula-display">
            Var[Z] =
            <span class="formula-term highlight-f2">F₂: <span id="val-f2">0</span></span>
            -
            <span class="formula-term highlight-fj">fⱼ²: <span id="val-fj2">0</span></span>
            =
            <strong><span id="val-var">0</span></strong>
        </div>

        <div class="error-vis">
            <div class="error-center"></div>
            <div class="error-range" id="error-bar" style="width: 0px;">
                <div class="label">Standard Deviation (σ)</div>
            </div>
        </div>

        <div class="feedback-panel">
            Click a bar to select item <em>j</em>. Notice how high frequency items (tall bars) reduce the variance!
        </div>
    </div>

    <script>
        const state = {
            numItems: 20,
            skew: 0,
            frequencies: [],
            selectedIdx: 0
        };

        const els = {
            chart: document.getElementById('chart'),
            skewSlider: document.getElementById('skew-slider'),
            skewVal: document.getElementById('skew-val'),
            valF2: document.getElementById('val-f2'),
            valFj2: document.getElementById('val-fj2'),
            valVar: document.getElementById('val-var'),
            errorBar: document.getElementById('error-bar')
        };

        function generateData() {
            state.frequencies = [];
            let total = 1000;

            // Zipf-like distribution generator
            // f_i = c / i^s
            let sum = 0;
            for (let i = 1; i <= state.numItems; i++) {
                sum += 1 / Math.pow(i, state.skew);
            }
            const c = total / sum;

            for (let i = 1; i <= state.numItems; i++) {
                state.frequencies.push(Math.round(c / Math.pow(i, state.skew)));
            }

            // Sort for better visualization
            state.frequencies.sort((a, b) => b - a);

            renderChart();
            updateStats();
        }

        function renderChart() {
            els.chart.innerHTML = '';
            const maxFreq = Math.max(...state.frequencies);

            state.frequencies.forEach((freq, idx) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                if (idx === state.selectedIdx) bar.classList.add('selected');

                // Height percentage
                const h = (freq / maxFreq) * 100;
                bar.style.height = `${h}%`;
                bar.title = `Item ${idx}: ${freq}`;

                bar.onclick = () => {
                    state.selectedIdx = idx;
                    renderChart(); // Re-render to update selection class
                    updateStats();
                };

                els.chart.appendChild(bar);
            });
        }

        function updateStats() {
            // Calculate F2
            const F2 = state.frequencies.reduce((sum, f) => sum + f * f, 0);

            // Get fj
            const fj = state.frequencies[state.selectedIdx];
            const fj2 = fj * fj;

            const variance = F2 - fj2;
            const stdDev = Math.sqrt(variance);

            // Update UI
            els.valF2.textContent = F2.toLocaleString();
            els.valFj2.textContent = fj2.toLocaleString();
            els.valVar.textContent = variance.toLocaleString();

            // Visualize Error Bar (scaled relative to total count for visibility)
            // Max possible std dev is roughly total count (if 1 item has all mass)
            // Let's scale it so max width is ~80% of container
            const scale = 300 / 1000; // Arbitrary visual scale
            els.errorBar.style.width = Math.min(400, stdDev * scale) + 'px';
        }

        els.skewSlider.addEventListener('input', (e) => {
            state.skew = parseFloat(e.target.value);
            els.skewVal.textContent = state.skew === 0 ? 'Uniform' : (state.skew > 1.5 ? 'Highly Skewed' : 'Skewed');
            generateData();
        });

        // Init
        generateData();

    </script>
</body>

</html>