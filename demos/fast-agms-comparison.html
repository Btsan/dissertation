<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGMS vs Fast-AGMS Comparison</title>
    <link rel="stylesheet" href="demo-common.css">
    <style>
        .comparison-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            flex: 1;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .panel h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .sketch-visual {
            display: flex;
            gap: 5px;
            margin: 20px 0;
        }

        .cell {
            width: 50px;
            height: 50px;
            border: 2px solid var(--color-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #f9fafb;
            transition: background 0.2s;
        }

        .cell.highlight {
            background: #e0f2fe;
        }

        .error-bar-container {
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-top: 10px;
        }

        .error-bar {
            height: 100%;
            background: var(--color-red);
            width: 0%;
            transition: width 0.3s;
        }

        .stats {
            font-size: 0.9em;
            color: var(--color-gray);
            margin-top: 5px;
        }

        .controls-area {
            text-align: center;
            margin-bottom: 20px;
        }

        .floating-item {
            position: fixed;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: floatDown 0.8s ease-out forwards;
            z-index: 100;
        }

        @keyframes floatDown {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(40px);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>AGMS vs Fast-AGMS Comparison</h2>

        <div class="controls-area">
            <button class="btn-stream" id="btn-stream">Start Stream</button>
            <button style="background-color: var(--color-gray);" id="btn-reset">Reset</button>
            <div style="margin-top: 10px; font-size: 0.9em;">
                Querying Item: <strong>"A"</strong> (True Count: <span id="true-count">0</span>)
            </div>
        </div>

        <div class="comparison-container">
            <!-- AGMS Panel -->
            <div class="panel">
                <h3>Standard AGMS</h3>
                <div class="sketch-visual">
                    <div class="cell" id="agms-cell">0</div>
                </div>
                <div>Estimate: <strong id="agms-est">0</strong></div>
                <div class="error-bar-container">
                    <div class="error-bar" id="agms-error-bar"></div>
                </div>
                <div class="stats">Abs Error: <span id="agms-error">0</span></div>
            </div>

            <!-- Fast-AGMS Panel -->
            <div class="panel">
                <h3>Fast-AGMS (Width=5)</h3>
                <div class="sketch-visual" id="fast-agms-grid">
                    <!-- Cells generated by JS -->
                </div>
                <div>Estimate: <strong id="fast-est">0</strong></div>
                <div class="error-bar-container">
                    <div class="error-bar" id="fast-error-bar" style="background-color: var(--color-green);"></div>
                </div>
                <div class="stats">Abs Error: <span id="fast-error">0</span></div>
            </div>
        </div>

        <div class="feedback-panel">
            <p><strong>Observation:</strong> Fast-AGMS (Median of Means) typically has lower variance (error) than a
                single AGMS counter, at the cost of more space.</p>
        </div>
    </div>

    <script src="../kwisehash.js"></script>
    <script>
        const CONFIG = {
            fastWidth: 5,
            targetItem: 'A'
        };

        const state = {
            agms: 0,
            fastAgms: new Array(CONFIG.fastWidth).fill(0),
            trueCount: 0,
            isStreaming: false,
            interval: null,
            // Hashes
            agmsHash: new window.KWiseHash.SignHash(1, 4, 100),
            fastHashBin: new window.KWiseHash.BinHash(1, CONFIG.fastWidth, 2, 200),
            fastHashSign: new window.KWiseHash.SignHash(1, 4, 200)
        };

        // DOM
        const els = {
            agmsCell: document.getElementById('agms-cell'),
            agmsEst: document.getElementById('agms-est'),
            agmsError: document.getElementById('agms-error'),
            agmsBar: document.getElementById('agms-error-bar'),

            fastGrid: document.getElementById('fast-agms-grid'),
            fastEst: document.getElementById('fast-est'),
            fastError: document.getElementById('fast-error'),
            fastBar: document.getElementById('fast-error-bar'),

            trueCount: document.getElementById('true-count'),
            btnStream: document.getElementById('btn-stream'),
            btnReset: document.getElementById('btn-reset')
        };

        function init() {
            // Init Fast Grid
            els.fastGrid.innerHTML = '';
            for (let i = 0; i < CONFIG.fastWidth; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `fast-cell-${i}`;
                cell.textContent = '0';
                els.fastGrid.appendChild(cell);
            }
        }

        function getHash(item, type) {
            let code = 0;
            for (let i = 0; i < item.length; i++) code += item.charCodeAt(i);

            if (type === 'agms') return state.agmsHash.hash(code, 0);
            if (type === 'fast-bin') return state.fastHashBin.hash(code, 0);
            if (type === 'fast-sign') return state.fastHashSign.hash(code, 0);
            return 0;
        }

        function updateUI() {
            els.trueCount.textContent = state.trueCount;

            // AGMS
            els.agmsCell.textContent = state.agms;

            // Fast AGMS
            state.fastAgms.forEach((val, idx) => {
                document.getElementById(`fast-cell-${idx}`).textContent = val;
            });

            // Estimates for Target "A"
            const code = CONFIG.targetItem.charCodeAt(0); // Simple hash input

            // AGMS Est
            const agmsSign = state.agmsHash.hash(code, 0); // Re-compute for query
            const agmsEst = state.agms * agmsSign;
            const agmsErr = Math.abs(agmsEst - state.trueCount);

            els.agmsEst.textContent = agmsEst;
            els.agmsError.textContent = agmsErr;
            els.agmsBar.style.width = Math.min(100, agmsErr * 5) + '%'; // Scale factor

            // Fast AGMS Est
            // For depth 1, Fast-AGMS is just one row. 
            // Estimate is val[h(x)] * s(x)
            const fastBin = state.fastHashBin.hash(code, 0);
            const fastSign = state.fastHashSign.hash(code, 0);
            const fastEst = state.fastAgms[fastBin] * fastSign;
            const fastErr = Math.abs(fastEst - state.trueCount);

            els.fastEst.textContent = fastEst;
            els.fastError.textContent = fastErr;
            els.fastBar.style.width = Math.min(100, fastErr * 5) + '%';
        }

        function spawnFloatingItem(item, targetEl, sign) {
            const el = document.createElement('div');
            el.className = 'floating-item';
            el.textContent = `${item} (${sign > 0 ? '+1' : '-1'})`;
            el.style.color = sign > 0 ? 'var(--color-green)' : 'var(--color-red)';

            const rect = targetEl.getBoundingClientRect();
            el.style.left = (rect.left + rect.width / 2 - 15) + 'px';
            el.style.top = (rect.top - 25) + 'px';

            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function insert(item) {
            if (item === CONFIG.targetItem) state.trueCount++;

            // AGMS Update
            const h1 = getHash(item, 'agms');
            state.agms += h1;
            spawnFloatingItem(item, els.agmsCell, h1);

            // Fast AGMS Update
            const bin = getHash(item, 'fast-bin');
            const sign = getHash(item, 'fast-sign');
            state.fastAgms[bin] += sign;

            const targetCell = document.getElementById(`fast-cell-${bin}`);
            spawnFloatingItem(item, targetCell, sign);

            updateUI();
        }

        // Stream Logic
        els.btnStream.onclick = () => {
            if (state.isStreaming) {
                clearInterval(state.interval);
                state.isStreaming = false;
                els.btnStream.textContent = "Start Stream";
                els.btnStream.style.backgroundColor = "var(--color-red)";
            } else {
                state.isStreaming = true;
                els.btnStream.textContent = "Stop Stream";
                els.btnStream.style.backgroundColor = "var(--color-dark)";

                const items = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                state.interval = setInterval(() => {
                    // Bias towards A to make it interesting
                    const r = Math.random();
                    const item = r < 0.3 ? 'A' : items[Math.floor(Math.random() * items.length)];
                    insert(item);
                }, 100);
            }
        };

        els.btnReset.onclick = () => {
            state.agms = 0;
            state.fastAgms.fill(0);
            state.trueCount = 0;
            updateUI();
        };

        init();
    </script>
</body>

</html>